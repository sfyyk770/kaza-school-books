<html>
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SchoolBookExpress Admin - Orders Management</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css" rel="stylesheet">
    <link href="styles.css" rel="stylesheet">
    <link rel="icon" href="https://www.judaica-world.com/media/favicon/default/favicon_2__1.jpg" type="image/x-icon">
    <link rel="shortcut icon" href="https://www.judaica-world.com/media/favicon/default/favicon_2__1.jpg" type="image/x-icon">
  </head>
  <body>
    <header>
      <div class="container">
        <a href="/" class="logo"><img src="../../public/uploads/judaica-world_logo.png" alt="judaica-world_logo" class="logo-image"></a>
        <nav>
          <ul>
            <li><a href="/admin"><i class="fas fa-tachometer-alt"></i> Dashboard</a></li>
            <li><a href="/admin/books"><i class="fas fa-book"></i> Books</a></li>
            <li><a href="/admin/orders"><i class="fas fa-shopping-cart"></i> Orders</a></li>
            <li><a href="/admin/users"><i class="fas fa-users"></i> Users</a></li>
            <li><a href="/admin/settings"><i class="fas fa-cog"></i> Settings</a></li>
            <li><a href="/logout"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
          </ul>
        </nav>
      </div>
    </header>
      
    <div class="container">
      <h1>Manage Orders</h1>
      
      <div class="filters">
        <div class="search-bar">
          <input type="text" placeholder="Search orders...">
          <button class="btn"><i class="fas fa-search"></i></button>
        </div>
        <div class="status-filter">
          <select>
            <option value="">All Statuses</option>
            <option value="PENDING">Pending</option>
            <option value="PROCESSING">Processing</option>
            <option value="SHIPPED">Shipped</option>
            <option value="DELIVERED">Delivered</option>
            <option value="CANCELLED">Cancelled</option>
          </select>
        </div>
        <div>
          <label for="rows-per-page">Rows per page:</label>
          <select id="rows-per-page">
            <option value="10">10</option>
            <option value="25">25</option>
            <option value="50">50</option>
            <option value="100">100</option>
          </select>
        </div>
        <button class="export-btn"><i class="fas fa-file-export"></i> Export</button>
      </div>
  
      <table id="orders-table">
        <thead>
          <tr>
            <th>
              Order ID
              <i class="fas fa-sort sort-icon" data-column="id"></i>
              <span class="column-filter">
                <i class="fas fa-filter column-filter-icon" data-column="id"></i>
                <div class="column-filter-dropdown">
                  <input type="text" placeholder="Filter Order ID">
                  <button>Apply</button>
                </div>
              </span>
            </th>
            <th>
              Customer
              <i class="fas fa-sort sort-icon" data-column="customer"></i>
              <span class="column-filter">
                <i class="fas fa-filter column-filter-icon" data-column="customer"></i>
                <div class="column-filter-dropdown">
                  <input type="text" placeholder="Filter Customer">
                  <button>Apply</button>
                </div>
              </span>
            </th>
            <th>
              Email
              <i class="fas fa-sort sort-icon" data-column="email"></i>
              <span class="column-filter">
                <i class="fas fa-filter column-filter-icon" data-column="email"></i>
                <div class="column-filter-dropdown">
                  <input type="text" placeholder="Filter Email">
                  <button>Apply</button>
                </div>
              </span>
            </th>
            <th>
              Phone
              <i class="fas fa-sort sort-icon" data-column="phone"></i>
              <span class="column-filter">
                <i class="fas fa-filter column-filter-icon" data-column="phone"></i>
                <div class="column-filter-dropdown">
                  <input type="text" placeholder="Filter Phone">
                  <button>Apply</button>
                </div>
              </span>
            </th>
            <th>
              Date
              <i class="fas fa-sort sort-icon" data-column="date"></i>
              <span class="column-filter">
                <i class="fas fa-filter column-filter-icon" data-column="date"></i>
                <div class="column-filter-dropdown">
                  <input type="date" placeholder="Filter Date">
                  <button>Apply</button>
                </div>
              </span>
            </th>
            <th>
              Total
              <i class="fas fa-sort sort-icon" data-column="total"></i>
              <span class="column-filter">
                <i class="fas fa-filter column-filter-icon" data-column="total"></i>
                <div class="column-filter-dropdown">
                  <input type="number" placeholder="Min Total">
                  <input type="number" placeholder="Max Total">
                  <button>Apply</button>
                </div>
              </span>
            </th>
            <th>
              Status
              <i class="fas fa-sort sort-icon" data-column="status"></i>
              <span class="column-filter">
                <i class="fas fa-filter column-filter-icon" data-column="status"></i>
                <div class="column-filter-dropdown">
                  <select>
                    <option value="">All Statuses</option>
                    <option value="pending">Pending</option>
                    <option value="processing">Processing</option>
                    <option value="shipped">Shipped</option>
                    <option value="delivered">Delivered</option>
                    <option value="cancelled">Cancelled</option>
                  </select>
                  <button>Apply</button>
                </div>
              </span>
            </th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <!-- Table rows will be dynamically populated here -->
        </tbody>
      </table>
  
      <div class="pagination">
        <a href="#" class="btn" id="prev-page"><i class="fas fa-chevron-left"></i> Previous</a>
        <span id="page-info">Page 1 of 1</span>
        <a href="#" class="btn" id="next-page">Next <i class="fas fa-chevron-right"></i></a>
      </div>
    </div>
  
    <!-- View Order Modal -->
    <div id="viewOrderModal" class="modal">
      <div class="modal-content">
        <span class="close">&times;</span>
        <h2>Order Details</h2>
        <div id="orderDetails" class="order-details">
          <!-- Order details will be dynamically populated here -->
        </div>
        <button class="print-label-btn"><i class="fas fa-print"></i> Print Shipping Label</button>
      </div>
    </div>
  
    <!-- Edit Order Modal -->
    <div id="editOrderModal" class="modal">
      <div class="modal-content">
        <span class="close">&times;</span>
        <h2>Edit Order</h2>
        <form id="editOrderForm">
          <div class="form-group">
            <label for="editOrderId">Order ID:</label>
            <input type="text" id="editOrderId" readonly>
          </div>
          <div class="form-group">
            <label for="editOrderDate">Order Date:</label>
            <input type="date" id="editOrderDate">
          </div>
          <div class="form-group">
            <label for="editCustomerName">Customer Name:</label>
            <input type="text" id="editCustomerName">
          </div>
          <div class="form-group">
            <label for="editCustomerEmail">Customer Email:</label>
            <input type="email" id="editCustomerEmail">
          </div>
          <div class="form-group">
            <label for="editCustomerPhone">Customer Phone:</label>
            <input type="tel" id="editCustomerPhone">
          </div>
          <div class="form-group">
            <label for="editStatus">Status:</label>
            <select id="editStatus">
              <option value="pending">Pending</option>
              <option value="processing">Processing</option>
              <option value="shipped">Shipped</option>
              <option value="delivered">Delivered</option>
              <option value="cancelled">Cancelled</option>
            </select>
          </div>
          <div class="form-group full-width">
            <label for="editShippingAddress">Shipping Address:</label>
            <textarea id="editShippingAddress"></textarea>
          </div>
          <div class="form-group full-width">
            <h3>Order Items</h3>
            <table id="editOrderItems">
              <thead>
                <tr>
                  <th>Item</th>
                  <th>Quantity</th>
                  <th>Price</th>
                  <th>Action</th>
                </tr>
              </thead>
              <tbody>
                <!-- Order items will be dynamically populated here -->
              </tbody>
            </table>
            <button type="button" id="addItemBtn" class="btn">Add Item</button>
          </div>
          <button type="submit" id="updateOrderBtn" class="btn">Update Order</button>
        </form>
      </div>
    </div>
  
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
      $(document).ready(function() {
        const API_URL = 'https://b7a0-2607-fb90-fe9b-b8a-e9a9-3731-5872-1c01.ngrok-free.app/api/orders';
        // const API_URL = 'http://localhost:3030/api/orders';

        const ordersData = [];
        // const ordersData = [
        //   {
        //     id: "#1001",
        //     customer: "John Doe",
        //     email: "john.doe@example.com",
        //     phone: "+1 (555) 123-4567",
        //     date: "2023-05-01",
        //     total: "$125.99",
        //     status: "shipped",
        //     shippingAddress: "123 Main St, Anytown, USA 12345",
        //     items: [
        //       { name: "The Great Gatsby", quantity: 1, price: "$15.99" },
        //       { name: "To Kill a Mockingbird", quantity: 2, price: "$12.99" },
        //       { name: "1984", quantity: 1, price: "$11.99" }
        //     ]
        //   },
        //   {
        //     id: "#1002",
        //     customer: "Jane Smith",
        //     email: "jane.smith@example.com",
        //     phone: "+1 (555) 987-6543",
        //     date: "2023-05-02",
        //     total: "$89.50",
        //     status: "processing",
        //     shippingAddress: "456 Elm St, Somewhere, USA 67890",
        //     items: [
        //       { name: "Pride and Prejudice", quantity: 1, price: "$10.99" },
        //       { name: "The Catcher in the Rye", quantity: 1, price: "$13.99" }
        //     ]
        //   },
        //   {
        //     id: "#1003",
        //     customer: "Bob Johnson",
        //     email: "bob.johnson@example.com",
        //     phone: "+1 (555) 246-8135",
        //     date: "2023-05-03",
        //     total: "$210.75",
        //     status: "delivered",
        //     shippingAddress: "789 Oak St, Elsewhere, USA 13579",
        //     items: [
        //       { name: "The Hobbit", quantity: 1, price: "$14.99" },
        //       { name: "Harry Potter and the Sorcerer's Stone", quantity: 1, price: "$24.99" },
        //       { name: "The Lord of the Rings Trilogy", quantity: 1, price: "$39.99" }
        //     ]
        //   },
        //   {
        //     id: "#1004",
        //     customer: "Alice Williams",
        //     email: "alice.williams@example.com",
        //     phone: "+1 (555) 369-2580",
        //     date: "2023-05-04",
        //     total: "$45.99",
        //     status: "pending",
        //     shippingAddress: "101 Pine St, Newtown, USA 24680",
        //     items: [
        //       { name: "The Alchemist", quantity: 1, price: "$12.99" },
        //       { name: "The Little Prince", quantity: 1, price: "$9.99" }
        //     ]
        //   },
        //   {
        //     id: "#1005",
        //     customer: "Charlie Brown",
        //     email: "charlie.brown@example.com",
        //     phone: "+1 (555) 147-2589",
        //     date: "2023-05-05",
        //     total: "$178.95",
        //     status: "cancelled",
        //     shippingAddress: "202 Maple Ave, Oldtown, USA 13579",
        //     items: [
        //       { name: "The Da Vinci Code", quantity: 1, price: "$14.99" },
        //       { name: "The Hunger Games Trilogy", quantity: 1, price: "$29.99" },
        //       { name: "The Chronicles of Narnia", quantity: 1, price: "$34.99" }
        //     ]
        //   }
        // ];
  
        let currentPage = 1;
        let rowsPerPage = 10;
        let sortColumn = 'id';
        let sortOrder = 'asc';
        let filters = {};
        let totalItems = 0;

        function showLoader() {
          $('.loader').css('display', 'flex');
        }

        function hideLoader() {
          $('.loader').css('display', 'none');
        }

        async function fetchOrders() {
          showLoader();
          try {
            const queryParams = new URLSearchParams({
              page: currentPage,
              limit: rowsPerPage,
              sort: sortColumn,
              order: sortOrder,
              ...filters
            });
            
            const response = await fetch(`${API_URL}?${queryParams}`);
            
            if (!response.ok) {
              throw new Error('API request failed');
            }
            const data = await response.json();
            totalItems = data.total;
            ordersData.push(...data.data);
            return data.data;
          } catch (error) {
            console.error('Error fetching orders:', error);
            // totalItems = fallbackOrdersData.length;
            return hideLoader();
          } finally {
            hideLoader();
          }
        }
  
        async function renderTable() {
          const orders = await fetchOrders();
          
          const tableBody = $('#orders-table tbody');
          tableBody.empty();

          if (orders?.length === 0) {
            const noResultsRow = `
              <tr>
                <td colspan="8" class="no-results">No results found</td>
              </tr>
            `;
            tableBody.append(noResultsRow);
          } else {
            orders.forEach(order => {
              const row = `
                <tr>
                  <td>${order.serial}</td>
                  <td>${order.customer}</td>
                  <td>${order.email}</td>
                  <td>${order.phone}</td>
                  <td>${order.date}</td>
                  <td>${'$'+order.prices.total}</td>
                  <td><span class="status-badge status-${order.status}">${order.status}</span></td>
                  <td class="action-buttons">
                    <button class="btn btn-view" data-id="${order._id}"><i class="fas fa-eye"></i> View</button>
                    <button class="btn btn-edit" data-id="${order._id}"><i class="fas fa-edit"></i> Edit</button>
                    <button class="btn btn-delete" data-id="${order._id}"><i class="fas fa-trash"></i> Delete</button>
                  </td>
                </tr>
              `;
              tableBody.append(row);
            });
          }

          updatePagination();
        }

        function updatePagination() {
          const totalPages = Math.ceil(totalItems / rowsPerPage);
          $('#page-info').text(`Page ${currentPage} of ${totalPages}`);
          $('#prev-page').toggleClass('disabled', currentPage === 1);
          $('#next-page').toggleClass('disabled', currentPage === totalPages || totalItems === 0);
        }
  
        $('#prev-page').click(function(e) {
          e.preventDefault();
          if (currentPage > 1) {
            currentPage--;
            renderTable();
          }
        });
  
        $('#next-page').click(function(e) {
          e.preventDefault();
          const totalPages = Math.ceil(ordersData.length / rowsPerPage);
          if (currentPage < totalPages) {
            currentPage++;
            renderTable();
          }
        });
  
        $('#rows-per-page').change(function() {
          rowsPerPage = parseInt($(this).val());
          currentPage = 1;
          renderTable();
        });
  
        $('.search-bar .btn').click(function() {
          const searchTerm = $('.search-bar input').val().toLowerCase();
          filters = { customer: searchTerm };
          currentPage = 1;
          renderTable();
        });
  
        $('.status-filter select').change(function() {
          const selectedStatus = $(this).val().toLowerCase();
          filters.status = selectedStatus;
          currentPage = 1;
          renderTable();
        });
  
        $('.sort-icon').click(function() {
          const column = $(this).data('column');
          if (sortColumn === column) {
            sortOrder = sortOrder === 'asc' ? 'desc' : 'asc';
          } else {
            sortColumn = column;
            sortOrder = 'asc';
          }
          renderTable();
        });
  
        $('.column-filter-icon').click(function(e) {
          e.stopPropagation();
          const dropdown = $(this).next('.column-filter-dropdown');
          $('.column-filter-dropdown').not(dropdown).hide();
          dropdown.toggle();
        });
  
        $('.column-filter-dropdown button').click(function(e) {
          e.preventDefault();
          const column = $(this).closest('.column-filter').find('.column-filter-icon').data('column');
          const input = $(this).siblings('input, select');
          if (input.length === 1) {
            filters[column] = input.val();
          } else if (input.length === 2) {
            const min = input.eq(0).val();
            const max = input.eq(1).val();
            if (min && max) {
              filters[column] = value => parseFloat(value) >= parseFloat(min) && parseFloat(value) <= parseFloat(max);
            } else if (min) {
              filters[column] = value => parseFloat(value) >= parseFloat(min);
            } else if (max) {
              filters[column] = value => parseFloat(value) <= parseFloat(max);
            }
          }
          currentPage = 1;
          renderTable();
          $(this).closest('.column-filter-dropdown').hide();
        });
  
        $(document).click(function(e) {
          if (!$(e.target).closest('.column-filter').length) {
            $('.column-filter-dropdown').hide();
          }
        });
  
        $('#orders-table').on('click', '.btn-view', function() {
          const orderId = $(this).data('id');
          const order = ordersData.find(o => o._id === orderId);
          const modal = $('#viewOrderModal');
          const orderDetails = $('#orderDetails');
  
          orderDetails.html(`
            <div>
              <h3>Order Information</h3>
              <p><strong>Order ID:</strong> ${order.serial}</p>
              <p><strong>Date:</strong> ${order.date}</p>
              <p><strong>Status:</strong> <span class="status-badge status-${order.status}">${order.status}</span></p>
              <p><strong>Total:</strong> ${order.total}</p>
            </div>
            <div>
              <h3>Customer Information</h3>
              <p><strong>Name:</strong> ${order.customer}</p>
              <p><strong>Email:</strong> ${order.email}</p>
              <p><strong>Phone:</strong> ${order.phone}</p>
            </div>
            <div>
              <h3>Shipping Address</h3>
              <p>${order.shippingAddress}</p>
            </div>
            <div class="order-items">
              <h3>Order Items</h3>
              <table>
                <thead>
                  <tr>
                    <th>Item</th>
                    <th>Quantity</th>
                    <th>Price</th>
                  </tr>
                </thead>
                <tbody>
                  ${order.items.map(item => `
                    <tr>
                      <td>${item.name}</td>
                      <td>${item.quantity}</td>
                      <td>${item.price}</td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
          `);
  
          modal.css('display', 'block');
        });
  
        $('#orders-table').on('click', '.btn-edit', function() {
          const orderId = $(this).data('id');
          const order = ordersData.find(o => o._id === orderId);
          const modal = $('#editOrderModal');
  
          $('#editOrderId').val(order.id);
          $('#editOrderDate').val(order.date);
          $('#editCustomerName').val(order.customer);
          $('#editCustomerEmail').val(order.email);
          $('#editCustomerPhone').val(order.phone);
          $('#editStatus').val(order.status);
          $('#editShippingAddress').val(order.shippingAddress);
  
          const itemsTable = $('#editOrderItems tbody');
          itemsTable.empty();
          order.items.forEach((item, index) => {
            itemsTable.append(`
              <tr>
                <td><input type="text" name="items[${index}][name]" value="${item.name}"></td>
                <td><input type="number" name="items[${index}][quantity]" value="${item.quantity}"></td>
                <td><input type="text" name="items[${index}][price]" value="${item.price}"></td>
                <td><button type="button" class="btn btn-delete-item">Remove</button></td>
              </tr>
            `);
          });
  
          modal.css('display', 'block');
        });
  
        $('#addItemBtn').click(function() {
          const itemsTable = $('#editOrderItems tbody');
          const newIndex = itemsTable.children().length;
          itemsTable.append(`
            <tr>
              <td><input type="text" name="items[${newIndex}][name]"></td>
              <td><input type="number" name="items[${newIndex}][quantity]"></td>
              <td><input type="text" name="items[${newIndex}][price]"></td>
              <td><button type="button" class="btn btn-delete-item">Remove</button></td>
            </tr>
          `);
        });
  
        $('#editOrderItems').on('click', '.btn-delete-item', function() {
          $(this).closest('tr').remove();
        });
  
        $('#editOrderForm').submit(function(e) {
          e.preventDefault();
          // Here you would typically send the form data to the server
          // For this example, we'll just close the modal
          $('#editOrderModal').css('display', 'none');
          alert('Order updated successfully!');
        });
  
        $('#orders-table').on('click', '.btn-delete', function() {
          const orderId = $(this).data('id');
          if (confirm(`Are you sure you want to delete order ${orderId}?`)) {
            // Here you would typically send a delete request to the server
            // For this example, we'll just remove the order from our local data
            const index = ordersData.findIndex(o => o.id === orderId);
            if (index !== -1) {
              ordersData.splice(index, 1);
              renderTable();
              alert('Order deleted successfully!');
            }
          }
        });
  
        $('.close').click(function() {
          $(this).closest('.modal').css('display', 'none');
        });
  
        $(window).click(function(e) {
          if ($(e.target).hasClass('modal')) {
            $('.modal').css('display', 'none');
          }
        });
  
        $('.export-btn').click(function() {
          // Here you would typically generate and download the export file
          // For this example, we'll just show an alert
          alert('Exporting orders data...');
        });
  
        $('.print-label-btn').click(function() {
          // Here you would typically generate and print the shipping label
          // For this example, we'll just show an alert
          alert('Printing shipping label...');
        });
  
        renderTable();
      });
    </script>
  </body>
  </html>